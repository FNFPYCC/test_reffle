# ruffier.py
"""
Модуль с математикой теста Руфье:
- вычисление индекса по трём измерениям пульса (каждое — за 15 секунд),
- возрастная нормировка («уровень неудовлетворительно»),
- перевод числового индекса в понятный текст, зависящий от возраста.
"""

# Строки для итогового вывода
txt_index = "Ваш индекс Руфье: "
txt_workheart = "Работоспособность сердца: "
txt_nodata = '\nнет данных для такого возраста'

# Набор текстов по уровням 0..4 (чем больше индекс — тем хуже уровень)
txt_res = []
txt_res.append('''низкая.
Срочно обратитесь к врачу!''')  # 0
txt_res.append('''удовлетворительная.
Обратитесь к врачу!''')        # 1
txt_res.append('''средняя.
Возможно, стоит дополнительно обследоваться у врача.''')  # 2
txt_res.append('''выше среднего''')  # 3
txt_res.append('''высокая''')        # 4

def ruffier_index(P1: int, P2: int, P3: int) -> float:
    """
    Индекс Руфье:
    - P1, P2, P3 — счёт пульса за 15 секунд (до нагрузки, сразу после, после короткого отдыха)
    - Переводим каждое измерение к ударам в минуту: ×4
    - Суммируем и подставляем в формулу:
         IR = (4 * (P1 + P2 + P3) - 200) / 10
    Чем МЕНЬШЕ индекс — тем лучше.
    """
    return (4 * (P1 + P2 + P3) - 200) / 10

def neud_level(age: int) -> float:
    """
    Возрастной порог «неудовлетворительно»:
    - В 7 лет: 21
    - Каждые 2 года порог уменьшается на 1.5 вплоть до 15 лет.
    Пример: 11 лет -> (11-7)//2 = 2 шага -> 21 - 2*1.5 = 18.0
    """
    norm_age = (min(age, 15) - 7) // 2
    result = 21 - norm_age * 1.5
    return result

def ruffier_result(r_index: float, level: float) -> int:
    """
    Переводим числовой индекс в целевой уровень 0..4:
    - Сравниваем с порогом «неуд» и последовательно снижаем порог:
      level, level-4, level-9, level-14.5
    - Как только индекс >= текущего порога — возвращаем уровень.
    - Если индекс меньше всех порогов — уровень 4 (лучший).
    """
    if r_index >= level:
        return 0
    level = level - 4
    if r_index >= level:
        return 1
    level = level - 5
    if r_index >= level:
        return 2
    level = level - 5.5
    if r_index >= level:
        return 3
    return 4

def test(P1: int, P2: int, P3: int, age: int) -> str:
    """
    Удобная «обёртка» для интерфейса:
    - Если возраст < 7, даём сообщение «нет данных».
    - Иначе считаем индекс, переводим в уровень и подставляем текст.
    - Возвращаем ГОТОВУЮ строку, которую UI просто покажет.
    """
    if age < 7:
        # Для надёжности возвращаем пару строк (индекс и «нет данных»),
        # но UI объединяет это как единый текст.
        return (txt_index + "0", txt_nodata)
    ruff_index = ruffier_index(P1, P2, P3)
    level = neud_level(age)
    grade = ruffier_result(ruff_index, level)
    result_text = txt_res[grade]
    # Округляем индекс до 1 знака после запятой для красоты
    return txt_index + str(round(ruff_index, 1)) + '\n' + txt_workheart + result_text
